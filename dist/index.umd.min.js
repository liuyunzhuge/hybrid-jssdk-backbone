!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e=e||self).HybridJssdkBackbone=n()}(this,function(){"use strict";function O(e,n){return Object.prototype.toString.call(e)==="[object ".concat(n,"]")}function _(){}return function(e){var n=e.isNative,t=e.timeout,a=void 0===t?1500:t,o=e.debug,r=void 0!==o&&o,i=e.logger,c=void 0===i?"hybrid-jssdk":i;function d(n){var e,t,o,r,i=(o=!(e=function(e){return n(e?w:null)}),function(){return o||(t=e.apply(this,arguments),o=!0),t});return s()?(b("bridge was ready"),i(s())):a?(setTimeout(function(){b("wakeup timeout"),i(s())},a),void(v?(r=i,b("wake up for android"),s()?r(s()):document.addEventListener("WebViewJavascriptBridgeReady",function(){b("bridge for android"),r(s())},!1)):function(e){if(b("wake up for apple"),s())return e(s());if(window.WVJBCallbacks)return window.WVJBCallbacks.push(e);window.WVJBCallbacks=[function(){b("bridge for apple")}];var n=document.createElement("iframe");n.style.display="none",n.src="https://__bridge_loaded__",document.documentElement.appendChild(n),setTimeout(function(){document.documentElement.removeChild(n)},0)}(i))):i(null)}function s(){return window.WebViewJavascriptBridge||null}function u(n,t){try{var e=JSON.parse(t);return O(e,"Object")?e:{message:t}}catch(e){return l("".concat(n," parse error:"),e),{message:t}}}function b(){if(r){for(var e,n=arguments.length,t=Array(n),o=0;o<n;o++)t[o]=arguments[o];(e=console).log.apply(e,["[".concat(c,"]")].concat(t))}}function l(){if(r){for(var e,n=arguments.length,t=Array(n),o=0;o<n;o++)t[o]=arguments[o];(e=console).error.apply(e,["[".concat(c,"]")].concat(t))}}var f=window.navigator.userAgent,v=!!f.match(/(Android);?[\s\/]+([\d.]+)?/),p=!!f.match(/\(Macintosh; Intel /),g=f.match(/(iPad).*OS\s([\d_]+)/),m=f.match(/(iPod)(.*OS\s([\d_]+))?/),h=!g&&f.match(/(iPhone\sOS)\s([\d_]+)/),k=!!(p||g||m||h),y=!!O(n,"Function")&&!!n(),w={},J=new Promise(function(e){return d(e)});return b("env settings:",{native:y,android:v,apple:k,timeout:a}),Object.assign(w,{ready:function(){return J},getBridge:s,toJson:function(e){try{return JSON.parse(e)}catch(e){return l(e),null}},invoke:function(e,n,t){var o=2<arguments.length&&void 0!==t?t:_;s()?s().callHandler(e,n,o):b("invoke invalid")},register:function(e,n,t){var o=2<arguments.length&&void 0!==t?t:_;s()?s().registerHandler(e,n,o):b("register invalid")},registerApi:function(e,n){var p,t,g,m,h,o=1<arguments.length&&void 0!==n?n:{},r=o.parseData,i=void 0===r?u:r,a=o.beforeInvoke,c=void 0===a?_:a,d=o.afterInvoke,s=void 0===d?_:d;return b("register api: ".concat(e)),this[e]=(p=e,g=(t={parseData:i,beforeInvoke:c,afterInvoke:s}).beforeInvoke,m=t.parseData,h=t.afterInvoke,function(){for(var e=arguments.length,n=Array(e),t=0;t<e;t++)n[t]=arguments[t];var o={},r={};1===n.length?(["success","fail","cancel","complete"].forEach(function(e){O(n[0][e],"Function")&&(r[e]=n[0][e],delete n[0][e])}),o=n[0]):n.length<2||(o=n[0],r=n[1]);var i=r.success,a=void 0===i?_:i,c=r.fail,d=void 0===c?_:c,s=r.complete,u=void 0===s?_:s,l=r.cancel,f=void 0===l?_:l,v=g(p,o)||o;b("invoke ".concat(p,", params:"),v),this.invoke(p,v,function(e){b("".concat(p," called, response:"),e);var n=m(p,e);n=h(p,n)||n,b("".concat(p," data after invoke:"),n);var t=n.message;if(b("".concat(p," message:"),n.message),t){var o=t.indexOf(":");switch(t.substring(1+o)){case"ok":a(n);break;case"cancel":f(n);break;default:d(n)}u(n)}})}),this[e]}}),w}});
